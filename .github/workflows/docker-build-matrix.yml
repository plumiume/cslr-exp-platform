# Docker Build Matrix - GitHub Actions ワークフロー
# ローカルランナーで定期ビルドを実行

name: Docker Build Matrix

on:
  # 定期実行スケジュール
  schedule:
    # 毎週月曜 02:00 JST (日曜 17:00 UTC) - Phase 1
    - cron: '0 17 * * 0'
    # 毎週水曜 02:00 JST (火曜 17:00 UTC) - Phase 2
    - cron: '0 17 * * 2'
    # 毎週金曜 02:00 JST (木曜 17:00 UTC) - Phase 3
    - cron: '0 17 * * 4'
  
  # 手動実行
  workflow_dispatch:
    inputs:
      build_phase:
        description: 'ビルドフェーズを選択'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - phase1
          - phase2
          - phase3
          - all
      cuda_version:
        description: 'CUDAバージョン（オプション）'
        required: false
        type: string
      python_version:
        description: 'Pythonバージョン（オプション）'
        required: false
        type: string
      target:
        description: 'ビルドターゲット（オプション）'
        required: false
        type: string

jobs:
  build-matrix:
    runs-on: [self-hosted, windows, docker]
    timeout-minutes: 480  # 8時間
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install uv
        run: |
          irm https://astral.sh/uv/install.ps1 | iex
        shell: pwsh
      
      - name: Install dependencies
        run: |
          uv sync
        shell: pwsh
      
      - name: Determine build parameters
        id: params
        run: |
          $phase = "${{ github.event.inputs.build_phase }}"
          $cuda = "${{ github.event.inputs.cuda_version }}"
          $python = "${{ github.event.inputs.python_version }}"
          $target = "${{ github.event.inputs.target }}"
          
          # スケジュール実行の場合、曜日に応じてフェーズを決定
          if ("${{ github.event_name }}" -eq "schedule") {
            $dayOfWeek = (Get-Date).DayOfWeek
            switch ($dayOfWeek) {
              "Monday" { $phase = "phase1" }
              "Wednesday" { $phase = "phase2" }
              "Friday" { $phase = "phase3" }
              default { $phase = "minimal" }
            }
          }
          
          echo "phase=$phase" >> $env:GITHUB_OUTPUT
          echo "cuda=$cuda" >> $env:GITHUB_OUTPUT
          echo "python=$python" >> $env:GITHUB_OUTPUT
          echo "target=$target" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Build Matrix - Minimal
        if: steps.params.outputs.phase == 'minimal'
        run: |
          uv run python tools/build_matrix.py --minimal
        shell: pwsh
      
      - name: Build Matrix - Phase 1
        if: steps.params.outputs.phase == 'phase1'
        run: |
          uv run python tools/build_matrix.py --cuda 12.8.1 --python 3.13 --target runtime
          uv run python tools/build_matrix.py --cuda 12.8.1 --python 3.13 --target ray-runtime
        shell: pwsh
      
      - name: Build Matrix - Phase 2
        if: steps.params.outputs.phase == 'phase2'
        run: |
          uv run python tools/build_matrix.py --cuda 12.8.1 --python 3.13 --target devel
          uv run python tools/build_matrix.py --cuda 12.8.1 --python 3.13 --target ray-devel
          uv run python tools/build_matrix.py --cuda 12.8.1 --python 3.13 --target marimo-devel
        shell: pwsh
      
      - name: Build Matrix - Phase 3
        if: steps.params.outputs.phase == 'phase3'
        run: |
          uv run python tools/build_matrix.py --cuda 13.1.1 --python 3.14
        shell: pwsh
      
      - name: Build Matrix - All
        if: steps.params.outputs.phase == 'all'
        run: |
          uv run python tools/build_matrix.py --all
        shell: pwsh
      
      - name: Build Matrix - Custom
        if: |
          steps.params.outputs.cuda != '' || 
          steps.params.outputs.python != '' || 
          steps.params.outputs.target != ''
        run: |
          $args = @()
          if ("${{ steps.params.outputs.cuda }}" -ne "") {
            $args += "--cuda", "${{ steps.params.outputs.cuda }}"
          }
          if ("${{ steps.params.outputs.python }}" -ne "") {
            $args += "--python", "${{ steps.params.outputs.python }}"
          }
          if ("${{ steps.params.outputs.target }}" -ne "") {
            $args += "--target", "${{ steps.params.outputs.target }}"
          }
          uv run python tools/build_matrix.py @args
        shell: pwsh
      
      - name: List built images
        if: always()
        run: |
          docker images plumiiume/cslr-exp-platform
        shell: pwsh
      
      - name: Docker system prune (cleanup)
        if: always()
        run: |
          docker system prune -f --volumes
        shell: pwsh
      
      - name: Update build status
        if: always()
        run: |
          $date = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          $status = if ($?) { "✅ 成功" } else { "❌ 失敗" }
          Write-Host "ビルド完了: $status at $date"
          # TODO: build_matrix.todo.md を更新
        shell: pwsh

  notify:
    runs-on: [self-hosted, windows]
    needs: build-matrix
    if: always()
    
    steps:
      - name: Notify completion
        run: |
          $status = "${{ needs.build-matrix.result }}"
          $emoji = if ($status -eq "success") { "✅" } else { "❌" }
          Write-Host "$emoji Docker Build Matrix: $status"
          # TODO: Slack/Discord/Email通知
        shell: pwsh
