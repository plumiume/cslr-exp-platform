# クラスターテスト用 Docker Compose 設定
# プロジェクト名: {{ project.name }}
# バージョン: {{ project.version }}

# メインクラスターからインポート
x-gpu: &gpu
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: all
            capabilities: [gpu]

{% set ray_target = cluster_test.target %}
{% set target_host = "ray-gpu" if ray_target == "gpu" else "ray-cpu" %}
{% set target_head_port = services.ray.gpu.head_port if ray_target == "gpu" else services.ray.cpu.head_port %}
{% set target_dashboard_port = services.ray.gpu.dashboard_port if ray_target == "gpu" else services.ray.cpu.dashboard_port %}
{% set target_client_port = services.ray.gpu.client_port if ray_target == "gpu" else services.ray.cpu.client_port %}

x-ray: &ray
{% if ray_target == "gpu" %}
  image: {{ services.ray.gpu.image }}
{% else %}
  image: {{ services.ray.cpu.image }}
{% endif %}
  restart: unless-stopped

services:
  # Main cluster services
{% if services.health.enabled %}
  health:
    image: python:3.12-alpine
    container_name: {{ project.name }}-health
    volumes:
      - ../template/health-ep.sh:/app/health-ep.sh:ro
    command: ["python3", "/app/health-ep.sh"]
    ports:
      - "0.0.0.0:{{ services.health.port }}:8080"
    networks:
      - ray-network
{% endif %}

{% if services.ray.cpu.enabled %}
  ray-cpu:
    <<: *ray
    container_name: {{ project.name }}-ray-cpu
    hostname: ray-cpu
    restart: "no"
    shm_size: '2gb'
    environment:
      - RAY_HEAD_PORT={{ services.ray.cpu.head_port }}
      - RAY_DASHBOARD_PORT={{ services.ray.cpu.dashboard_port }}
      - RAY_CLIENT_PORT={{ services.ray.cpu.client_port }}
      - HEAD_WHITELIST={{ nodes.head_whitelist | join(' ') }}
      - HEAD_ADDRESS_CFG={{ nodes.head_address or '' }}
      - HEALTH_URL={{ nodes.health_service.url }}
      - HEALTH_TIMEOUT={{ nodes.health_service.timeout }}
      - DISCOVERY_TIMEOUT={{ nodes.cluster.discovery_timeout }}
      - WAIT_FOR_HEAD={{ nodes.cluster.wait_for_head }}
{% if services.ray.cpu.cpus %}
      - RAY_NUM_CPUS={{ services.ray.cpu.cpus }}
{% endif %}
      - USE_CONDA_ENV=1
    volumes:
      - ../template/ray-ep.sh:/app/ray-ep.sh:ro
    user: root
    entrypoint: ["/bin/bash", "-c", "apt-get update -qq && apt-get install -y -qq curl > /dev/null 2>&1 && /app/ray-ep.sh"]
{% if services.health.enabled %}
    depends_on:
      - health
{% endif %}
{% if services.ray.cpu.cpus or services.ray.cpu.memory %}
    deploy:
      resources:
        limits:
{% if services.ray.cpu.cpus %}
          cpus: "{{ services.ray.cpu.cpus }}"
{% endif %}
{% if services.ray.cpu.memory %}
          memory: {{ services.ray.cpu.memory }}
{% endif %}
{% endif %}
    ports:
      - "{{ services.ray.cpu.dashboard_port }}:{{ services.ray.cpu.dashboard_port }}"
      - "{{ services.ray.cpu.client_port }}:{{ services.ray.cpu.client_port }}"
      - "{{ services.ray.cpu.head_port }}:{{ services.ray.cpu.head_port }}"
    networks:
      - ray-network
{% endif %}

{% if host.has_gpu and services.ray.gpu.enabled %}
  ray-gpu:
    <<: [*ray, *gpu]
    image: {{ services.ray.gpu.image }}
    container_name: {{ project.name }}-ray-gpu
    hostname: ray-gpu
    restart: "no"
    shm_size: '2gb'
    environment:
      - RAY_HEAD_PORT={{ services.ray.gpu.head_port }}
      - RAY_DASHBOARD_PORT={{ services.ray.gpu.dashboard_port }}
      - RAY_CLIENT_PORT={{ services.ray.gpu.client_port }}
      - HEAD_WHITELIST={{ nodes.head_whitelist | join(' ') }}
      - HEAD_ADDRESS_CFG={{ nodes.head_address or '' }}
      - HEALTH_URL={{ nodes.health_service.url }}
      - HEALTH_TIMEOUT={{ nodes.health_service.timeout }}
      - DISCOVERY_TIMEOUT={{ nodes.cluster.discovery_timeout }}
      - WAIT_FOR_HEAD={{ nodes.cluster.wait_for_head }}
      - RAY_NUM_GPUS=1
{% if services.ray.gpu.cpus %}
      - RAY_NUM_CPUS={{ services.ray.gpu.cpus }}
{% endif %}
      - USE_CONDA_ENV=1
    volumes:
      - ../template/ray-ep.sh:/app/ray-ep.sh:ro
    user: root
    entrypoint: ["/bin/bash", "-c", "apt-get update -qq && apt-get install -y -qq curl > /dev/null 2>&1 && /app/ray-ep.sh"]
{% if services.health.enabled %}
    depends_on:
      - health
{% endif %}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
{% if services.ray.gpu.cpus or services.ray.gpu.memory %}
        limits:
{% if services.ray.gpu.cpus %}
          cpus: "{{ services.ray.gpu.cpus }}"
{% endif %}
{% if services.ray.gpu.memory %}
          memory: {{ services.ray.gpu.memory }}
{% endif %}
{% endif %}
    ports:
      - "{{ services.ray.gpu.dashboard_port }}:{{ services.ray.gpu.dashboard_port }}"
      - "{{ services.ray.gpu.client_port }}:{{ services.ray.gpu.client_port }}"
      - "{{ services.ray.gpu.head_port }}:{{ services.ray.gpu.head_port }}"
    networks:
      - ray-network
{% endif %}

  # Test containers - Network isolated
  test-ray-client:
    <<: *ray
    container_name: {{ project.name }}-test-client
    hostname: test-ray-client
    restart: "no"
    shm_size: '1gb'
    extra_hosts:
      - "{{ target_host }}:{{ host.ip_address }}"
      - "health:{{ host.ip_address }}"
    environment:
      - RAY_HEAD_PORT={{ target_head_port }}
      - RAY_DASHBOARD_PORT={{ target_dashboard_port }}
      - RAY_CLIENT_PORT={{ target_client_port }}
      - HEAD_WHITELIST={{ nodes.head_whitelist | join(' ') }}
      - HEAD_ADDRESS_CFG={{ nodes.head_address or '' }}
      - HEALTH_URL={{ nodes.health_service.url }}
      - HEALTH_TIMEOUT={{ nodes.health_service.timeout }}
      - DISCOVERY_TIMEOUT={{ nodes.cluster.discovery_timeout }}
      - WAIT_FOR_HEAD={{ nodes.cluster.wait_for_head }}
      - RAY_NUM_CPUS=1
    volumes:
      - ../template/ray-ep.sh:/app/ray-ep.sh:ro
    user: root
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        apt-get update -qq && apt-get install -y -qq curl iputils-ping dnsutils > /dev/null 2>&1
        echo "=== Test Ray Client Network Test ==="
        echo "Testing connectivity to main cluster..."
        
        # DNS/Network connectivity test
        ping -c 2 {{ target_host }} || echo "⚠ Cannot ping {{ target_host }}"
        ping -c 2 health || echo "⚠ Cannot ping health"
        
        # Port connectivity test
        timeout 2 bash -c "</dev/tcp/{{ target_host }}/{{ target_head_port }}" && echo "✓ {{ target_host }}:{{ target_head_port }} reachable" || echo "✗ {{ target_host }}:{{ target_head_port }} unreachable"
        timeout 2 bash -c "</dev/tcp/health/8080" && echo "✓ health:8080 reachable" || echo "✗ health:8080 unreachable"
        
        # Ray client connection test
        echo ""
        echo "Testing Ray client connection..."
        su - ray -c "python3 -c 'import ray; ray.init(\"ray://{{ host.ip_address }}:{{ target_client_port }}\", ignore_reinit_error=True); print(\"✓ Ray client connected\"); print(\"Resources:\", ray.cluster_resources()); ray.shutdown()' || echo '✗ Ray client connection failed'"
        
        echo ""
        echo "Test client container will sleep for debugging..."
        tail -f /dev/null
    depends_on:
      - {{ target_host }}
{% if services.health.enabled %}
      - health
{% endif %}
    networks:
      - test-network

  test-ray-worker:
    <<: *ray
    container_name: {{ project.name }}-test-worker
    hostname: test-ray-worker
    restart: "no"
    shm_size: '1gb'
    extra_hosts:
      - "{{ target_host }}:{{ host.ip_address }}"
      - "health:{{ host.ip_address }}"
    environment:
      - RAY_HEAD_PORT={{ target_head_port }}
      - RAY_DASHBOARD_PORT={{ target_dashboard_port }}
      - RAY_CLIENT_PORT={{ target_client_port }}
      - HEAD_WHITELIST={{ nodes.head_whitelist | join(' ') }}
      - HEAD_ADDRESS_CFG={{ nodes.head_address or '' }}
      - HEALTH_URL={{ nodes.health_service.url }}
      - HEALTH_TIMEOUT={{ nodes.health_service.timeout }}
      - DISCOVERY_TIMEOUT={{ nodes.cluster.discovery_timeout }}
      - WAIT_FOR_HEAD={{ nodes.cluster.wait_for_head }}
      - RAY_NUM_CPUS=2
      - HEAD_ADDRESS={{ target_host }}:{{ target_head_port }}
    volumes:
      - ../template/ray-ep.sh:/app/ray-ep.sh:ro
    user: root
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        apt-get update -qq && apt-get install -y -qq curl iputils-ping > /dev/null 2>&1
        echo "=== Test Ray Worker Network Test ==="
        echo "Testing connectivity to main cluster..."
        
        # Network connectivity test
        ping -c 2 {{ target_host }} ||  echo "⚠ Cannot ping {{ target_host }}"
        timeout 2 bash -c "</dev/tcp/{{ target_host }}/{{ target_head_port }}" && echo "✓ {{ target_host }}:{{ target_head_port }} reachable" || echo "✗ {{ target_host }}:{{ target_head_port }} unreachable"
        timeout 2 bash -c "</dev/tcp/health/8080" && echo "✓ health:8080 reachable" || echo "✗ health:8080 unreachable"
        
        # Verify ray-ep.sh compatibility (should start as worker)
        echo ""
        echo "Starting Ray worker node using ray-ep.sh..."
        echo "This node is NOT in whitelist, so should start as WORKER automatically"
        
        export USE_CONDA_ENV=1
        /app/ray-ep.sh
    depends_on:
      - {{ target_host }}
{% if services.health.enabled %}
      - health
{% endif %}
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2g
    networks:
      - test-network

networks:
  ray-network:
    driver: bridge
    ipam:
      config:
        - subnet: {{ network.subnet }}
  
  # Isolated test network
  test-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24

volumes:
  mlflow_data:
  postgres_data:
  ray_data:
